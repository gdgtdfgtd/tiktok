<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireTok Infinity 2.0 üî•</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --fire: #ff4500; --gold: #ffcc00; --bg: #000; --panel: #161616; --accent: #ff2d55; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: var(--bg); color: #fff; overflow: hidden; height: 100vh; width: 100vw; }

        /* --- UI UTILS --- */
        .hidden { display: none !important; }
        .btn-fire { background: linear-gradient(45deg, var(--fire), var(--gold)); border: none; border-radius: 12px; color: #000; font-weight: bold; padding: 12px; cursor: pointer; transition: 0.2s; }
        .btn-fire:active { transform: scale(0.95); }

        /* --- AUTH --- */
        #auth-page { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .auth-form { background: var(--panel); padding: 25px; border-radius: 20px; border: 1px solid #333; }
        input, textarea { width: 100%; padding: 14px; margin: 8px 0; background: #222; border: 1px solid #333; color: #fff; border-radius: 10px; font-size: 16px; outline: none; }

        /* --- FEED --- */
        .feed-container { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .feed-container::-webkit-scrollbar { display: none; }
        .video-player { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Overlay */
        .overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 40%); pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px 20px 80px; }
        .overlay > * { pointer-events: auto; }
        .v-meta h3 { color: var(--gold); margin-bottom: 5px; }
        .v-meta p { font-size: 14px; opacity: 0.9; }

        /* Sidebar */
        .sidebar { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .side-btn { text-align: center; cursor: pointer; }
        .side-btn i { font-size: 32px; filter: drop-shadow(0 0 5px #000); transition: 0.2s; }
        .side-btn span { display: block; font-size: 12px; margin-top: 4px; font-weight: bold; }
        .liked { color: var(--fire) !important; }

        /* --- NAV --- */
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav i { font-size: 22px; color: #777; cursor: pointer; }
        .nav i.active { color: #fff; }
        .add-btn { font-size: 35px !important; color: var(--fire) !important; }

        /* --- PAGES --- */
        .page { position: fixed; inset: 0; background: #000; z-index: 800; display: none; overflow-y: auto; padding-bottom: 70px; }
        .p-info { text-align: center; padding: 40px 20px; }
        .p-ava { width: 90px; height: 90px; border-radius: 50%; border: 2px solid var(--fire); margin: 0 auto 15px; background: #333; }
        .p-stats { display: flex; justify-content: center; gap: 25px; margin-bottom: 20px; }
        .p-stats div { text-align: center; }
        .p-stats b { display: block; font-size: 18px; }

        /* Grids */
        .v-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; }
        .thumb { height: 160px; background: #111; cursor: pointer; overflow: hidden; position: relative; }
        .thumb video { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        /* --- DRAWERS (COMM, UPLOAD) --- */
        .drawer { position: fixed; bottom: -100%; left: 0; width: 100%; height: 75%; background: var(--panel); z-index: 2000; border-radius: 20px 20px 0 0; transition: 0.4s cubic-bezier(0, 1, 0.5, 1); display: flex; flex-direction: column; }
        .drawer.open { bottom: 0; }
        .dr-head { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid #333; }
        .dr-list { flex: 1; overflow-y: auto; padding: 15px; }
        
        .c-item { margin-bottom: 12px; font-size: 14px; }
        .c-user { font-weight: bold; color: var(--fire); margin-right: 5px; }
        
        .input-bar { padding: 15px; background: #111; display: flex; gap: 10px; align-items: center; }
        .input-bar input { margin: 0; }

        /* Media in comments */
        .media-msg { background: #333; padding: 8px; border-radius: 10px; display: inline-block; margin-top: 5px; }
        .voice { color: #00ff00; }

        /* --- UPLOAD MODAL --- */
        #upload-page { padding: 20px; text-align: center; }
        .up-preview { width: 100%; height: 250px; background: #222; border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed var(--fire); }
    </style>
</head>
<body>

    <!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
    <div id="auth-page">
        <div class="auth-form">
            <h1 style="color:var(--fire); text-align:center; margin-bottom:20px">FireTok üî•</h1>
            <input type="text" id="reg-name" placeholder="–ò–º—è">
            <input type="text" id="reg-user" placeholder="@username">
            <button class="btn-fire" style="width:100%" onclick="registerUser()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>

    <!-- –ì–õ–ê–í–ù–ê–Ø –õ–ï–ù–¢–ê -->
    <div id="feed-page" class="feed-container"></div>

    <!-- –ü–û–ò–°–ö -->
    <div id="search-page" class="page">
        <div style="padding:15px">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ö–µ—à—Ç–µ–≥–∞–º..." oninput="searchVideos()">
        </div>
        <div id="search-grid" class="v-grid"></div>
    </div>

    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="profile-page" class="page">
        <div class="p-info">
            <div class="p-ava" id="p-ava"></div>
            <h2 id="p-display-name">User</h2>
            <p id="p-display-user" style="color:gray">@user</p>
            <div class="p-stats">
                <div><b id="stat-subs">1.2M</b>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                <div><b id="stat-likes">0</b>–õ–∞–π–∫–∏</div>
                <div><b id="stat-vids">0</b>–í–∏–¥–µ–æ</div>
            </div>
            <button class="btn-fire" style="padding:8px 20px" onclick="location.reload()">–í—ã–π—Ç–∏</button>
        </div>
        <div id="my-grid" class="v-grid"></div>
    </div>

    <!-- –ó–ê–ì–†–£–ó–ö–ê -->
    <div id="upload-drawer" class="drawer">
        <div class="dr-head">–ü—É–±–ª–∏–∫–∞—Ü–∏—è –û–≥–æ–Ω—å–∫–∞ üî• <span style="float:right" onclick="toggleDrawer('upload-drawer', false)">‚úï</span></div>
        <div id="upload-page">
            <div class="up-preview" id="up-preview">
                <p style="color:gray">–í–∏–¥–µ–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</p>
            </div>
            <textarea id="up-desc" placeholder="–î–æ–±–∞–≤—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏ #—Ö–µ—à—Ç–µ–≥–∏..."></textarea>
            <button class="btn-fire" style="width:100%" onclick="saveVideo()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <!-- –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò -->
    <div id="comm-drawer" class="drawer">
        <div class="dr-head">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ <span style="float:right" onclick="toggleDrawer('comm-drawer', false)">‚úï</span></div>
        <div class="dr-list" id="comm-list"></div>
        <div class="input-bar">
            <i class="fas fa-microphone" style="color:var(--fire)" onclick="addMediaComment('voice')"></i>
            <i class="fas fa-camera" style="color:cyan" onclick="addMediaComment('photo')"></i>
            <input type="text" id="c-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å...">
            <i class="fas fa-paper-plane" onclick="addTextComment()"></i>
        </div>
    </div>

    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <div class="nav">
        <i class="fas fa-home active" onclick="showPage('feed')"></i>
        <i class="fas fa-search" onclick="showPage('search')"></i>
        <i class="fas fa-plus-square add-btn" onclick="triggerUpload()"></i>
        <i class="fas fa-heart" onclick="alert('–í—Å–µ –¥—Ä—É–∑—å—è –ª–∞–π–∫–Ω—É–ª–∏ –≤–∞—Å!')"></i>
        <i class="fas fa-user" onclick="showPage('profile')"></i>
    </div>

    <input type="file" id="file-input" accept="video/*" class="hidden" onchange="previewFile(this)">

    <script>
        // --- DATABASE ---
        let db;
        const request = indexedDB.open("FireTokDB", 2);
        request.onupgradeneeded = e => {
            db = e.target.result;
            if(!db.objectStoreNames.contains("videos")) {
                db.createObjectStore("videos", { keyPath: "id", autoIncrement: true });
            }
        };
        request.onsuccess = e => { db = e.target.result; initApp(); };

        let user = JSON.parse(localStorage.getItem('ft_user')) || null;
        let activeVideoId = null;
        let tempVideoFile = null;

        function registerUser() {
            const name = document.getElementById('reg-name').value;
            const handle = document.getElementById('reg-user').value;
            if(!name || !handle) return alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ!");
            user = { name, handle: handle.startsWith('@')?handle:'@'+handle, likes: 0 };
            localStorage.setItem('ft_user', JSON.stringify(user));
            location.reload();
        }

        function initApp() {
            if(!user) return;
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('p-display-name').innerText = user.name;
            document.getElementById('p-display-user').innerText = user.handle;
            document.getElementById('p-ava').innerHTML = `<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${user.handle}" style="width:100%">`;
            renderFeed();
        }

        // --- NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active'));
            
            if(pageId === 'feed') {
                document.querySelector('.fa-home').classList.add('active');
            } else {
                document.getElementById(pageId + '-page').style.display = 'block';
                document.querySelector('.fa-' + (pageId==='profile'?'user':'search')).classList.add('active');
                if(pageId === 'profile') updateProfile();
            }
        }

        function toggleDrawer(id, show) {
            const d = document.getElementById(id);
            if(show) d.classList.add('open');
            else d.classList.remove('open');
        }

        // --- VIDEO LOGIC ---
        async function renderFeed() {
            const feed = document.getElementById('feed-page');
            feed.innerHTML = "";
            const store = db.transaction("videos", "readonly").objectStore("videos");
            const all = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));

            if(all.length === 0) {
                feed.innerHTML = `<div style="text-align:center; padding:100px 20px"><h2>–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞ üî•</h2><p>–ë—É–¥—å –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç –≤–∏–¥–µ–æ!</p></div>`;
            }

            all.reverse().forEach(v => {
                const url = URL.createObjectURL(v.file);
                const item = document.createElement('div');
                item.className = 'video-player';
                item.id = "vid-" + v.id;
                item.innerHTML = `
                    <video src="${url}" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="sidebar">
                        <div class="side-btn" onclick="likeVideo(${v.id}, this)">
                            <i class="fas fa-heart ${v.likedByMe?'liked':''}"></i>
                            <span>${v.likes}</span>
                        </div>
                        <div class="side-btn" onclick="openComments(${v.id})">
                            <i class="fas fa-comment-dots"></i>
                            <span>${(v.comments || []).length}</span>
                        </div>
                        <div class="side-btn" onclick="alert('–†–µ–ø–æ—Å—Ç —Å–¥–µ–ª–∞–Ω!')">
                            <i class="fas fa-share"></i>
                            <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                        </div>
                    </div>
                    <div class="overlay">
                        <div class="v-meta">
                            <h3>${v.author}</h3>
                            <p>${v.desc}</p>
                        </div>
                    </div>
                `;
                feed.appendChild(item);
            });
            setupObserver();
        }

        function setupObserver() {
            const obs = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const v = entry.target.querySelector('video');
                    if(entry.isIntersecting) v.play().catch(e=>{});
                    else v.pause();
                });
            }, {threshold: 0.8});
            document.querySelectorAll('.video-player').forEach(p => obs.observe(p));
        }

        // --- UPLOAD ---
        function triggerUpload() {
            document.getElementById('file-input').click();
        }

        function previewFile(input) {
            const file = input.files[0];
            if(!file) return;
            tempVideoFile = file;
            const url = URL.createObjectURL(file);
            document.getElementById('up-preview').innerHTML = `<video src="${url}" muted autoplay loop style="width:100%;height:100%;object-fit:cover"></video>`;
            toggleDrawer('upload-drawer', true);
        }

        async function saveVideo() {
            if(!tempVideoFile) return;
            const desc = document.getElementById('up-desc').value;
            const tx = db.transaction("videos", "readwrite");
            tx.objectStore("videos").add({
                file: tempVideoFile,
                author: user.handle,
                desc: desc || "",
                likes: 0,
                comments: [],
                likedByMe: false
            });
            tx.oncomplete = () => {
                toggleDrawer('upload-drawer', false);
                renderFeed();
                showPage('feed');
                alert("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞!");
            };
        }

        // --- ACTIONS ---
        async function likeVideo(id, btn) {
            const tx = db.transaction("videos", "readwrite");
            const store = tx.objectStore("videos");
            const v = await new Promise(r => store.get(id).onsuccess = e => r(e.target.result));
            
            v.likedByMe = !v.likedByMe;
            v.likes += v.likedByMe ? 1 : -1;
            
            store.put(v);
            btn.querySelector('i').classList.toggle('liked');
            btn.querySelector('span').innerText = v.likes;
        }

        async function openComments(id) {
            activeVideoId = id;
            toggleDrawer('comm-drawer', true);
            renderComments();
        }

        async function renderComments() {
            const list = document.getElementById('comm-list');
            list.innerHTML = "";
            const store = db.transaction("videos", "readonly").objectStore("videos");
            const v = await new Promise(r => store.get(activeVideoId).onsuccess = e => r(e.target.result));
            
            if(v.comments) {
                v.comments.forEach(c => {
                    list.innerHTML += `<div class="c-item"><span class="c-user">${c.u}</span> ${c.t}</div>`;
                });
            }
        }

        async function addTextComment() {
            const input = document.getElementById('c-input');
            if(!input.value) return;
            await saveComment(input.value);
            input.value = "";
        }

        async function addMediaComment(type) {
            const msg = type === 'voice' ? `<div class="media-msg voice"><i class="fas fa-play"></i> –ì–° 0:05</div>` : `<div class="media-msg">üì∏ [–§–æ—Ç–æ]</div>`;
            await saveComment(msg);
        }

        async function saveComment(text) {
            const tx = db.transaction("videos", "readwrite");
            const store = tx.objectStore("videos");
            const v = await new Promise(r => store.get(activeVideoId).onsuccess = e => r(e.target.result));
            v.comments.push({ u: user.handle, t: text });
            store.put(v);
            tx.oncomplete = renderComments;
        }

        // --- SEARCH & PROFILE GRID ---
        async function updateProfile() {
            const grid = document.getElementById('my-grid');
            grid.innerHTML = "";
            const store = db.transaction("videos", "readonly").objectStore("videos");
            const all = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));
            const my = all.filter(v => v.author === user.handle);
            
            document.getElementById('stat-vids').innerText = my.length;
            let totalL = 0;
            my.forEach(v => {
                totalL += v.likes;
                const url = URL.createObjectURL(v.file);
                grid.innerHTML += `<div class="thumb" onclick="goToVideo(${v.id})"><video src="${url}"></video></div>`;
            });
            document.getElementById('stat-likes').innerText = totalL;
        }

        async function searchVideos() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const grid = document.getElementById('search-grid');
            grid.innerHTML = "";
            if(!q) return;
            
            const store = db.transaction("videos", "readonly").objectStore("videos");
            const all = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));
            const found = all.filter(v => v.desc.toLowerCase().includes(q) || v.author.toLowerCase().includes(q));
            
            found.forEach(v => {
                const url = URL.createObjectURL(v.file);
                grid.innerHTML += `<div class="thumb" onclick="goToVideo(${v.id})"><video src="${url}"></video></div>`;
            });
        }

        function goToVideo(id) {
            showPage('feed');
            const target = document.getElementById('vid-' + id);
            if(target) target.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
