<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DarkTok Online | Global Feed</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --accent: #ff003c; --bg: #000; --surface: #121212; --text: #fff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }

        /* DISCLAIMER */
        #disclaimer-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 25px; }
        .dis-card { background: var(--surface); padding: 30px; border-radius: 25px; max-width: 450px; border: 1px solid #333; text-align: center; }
        
        /* FEED */
        .feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .feed::-webkit-scrollbar { display: none; }
        .v-item { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; display: flex; align-items: center; justify-content: center; background: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* UI */
        .sidebar { position: absolute; right: 12px; bottom: 150px; display: flex; flex-direction: column; gap: 25px; align-items: center; }
        .btn-side { text-align: center; cursor: pointer; color: #fff; text-shadow: 0 0 10px #000; }
        .is-liked { color: var(--accent) !important; }
        .v-code { background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; margin-bottom: 10px; display: inline-block; }

        .drawer { position: fixed; bottom: -100%; left: 0; width: 100%; height: 75%; background: var(--surface); z-index: 6000; border-radius: 25px 25px 0 0; border-top: 1px solid #333; transition: 0.4s; display: flex; flex-direction: column; }
        .drawer.active { bottom: 0; }
        .comm-list { flex: 1; overflow-y: auto; padding: 15px; }
        
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: rgba(0,0,0,0.9); border-top: 1px solid #1a1a1a; display: flex; justify-content: space-around; align-items: center; z-index: 5000; }
        .nav i { font-size: 24px; color: #444; cursor: pointer; }
        .nav i.active { color: #fff; }

        .btn-fire { background: var(--accent); color: #fff; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        .panel { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: none; flex-direction: column; padding-bottom: 70px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; }
        .grid-item { height: 160px; background: #111; position: relative; overflow: hidden; }
        .del-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: var(--accent); border: none; padding: 5px; border-radius: 5px; }
        
        #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 11000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- ЗАГРУЗКА -->
    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: var(--accent);"></i>
        <p style="margin-top: 15px;">Загрузка в облако...</p>
    </div>

    <!-- ДИСКЛЕЙМЕР -->
    <div id="disclaimer-overlay">
        <div class="dis-card">
            <h2>DarkTok Online</h2>
            <p id="legal-text">
                Входя в глобальную сеть, вы подтверждаете, что вся ответственность за публикуемый контент лежит на вас. 
                Разработчик не модерирует видео в реальном времени. Нажимая кнопку, вы соглашаетесь с правилами анонимного сообщества.
            </p>
            <button class="btn-fire" id="btn-voice" onclick="startVoice()">Прослушать и войти</button>
            <div id="dis-controls" style="display:none; margin-top:20px;">
                <button class="btn-fire" onclick="acceptAll()">Принять условия</button>
            </div>
        </div>
    </div>

    <!-- ЛЕНТА -->
    <div class="feed" id="main-feed"></div>

    <!-- ПАНЕЛИ -->
    <div id="panel-search" class="panel">
        <div style="padding:20px; text-align:center; font-weight:bold; border-bottom:1px solid #222">ПОИСК</div>
        <div style="padding:15px"><input type="text" id="search-input" style="width:100%; padding:15px; background:#111; border:1px solid #333; border-radius:10px; color:#fff;" placeholder="Код видео DT-XXXX" oninput="searchGlobal(this.value)"></div>
        <div class="grid" id="search-results"></div>
    </div>

    <div id="panel-profile" class="panel">
        <div style="padding:20px; text-align:center; font-weight:bold; border-bottom:1px solid #222" id="user-nick">@аноним</div>
        <div class="grid" id="profile-grid"></div>
    </div>

    <div id="panel-publish" class="panel" style="padding:20px">
        <div style="width:100%; height:250px; background:#0a0a0a; border-radius:15px; border:2px dashed #333; display:flex; align-items:center; justify-content:center; overflow:hidden" onclick="document.getElementById('file-vid').click()" id="up-preview">Выбрать видео</div>
        <input type="file" id="file-vid" accept="video/*" hidden onchange="preview(this)">
        <input type="text" id="up-desc" style="width:100%; padding:15px; background:#111; margin-top:15px; border:1px solid #333; border-radius:10px; color:#fff" placeholder="Описание...">
        <button class="btn-fire" style="margin-top:20px" onclick="uploadToCloud()">ОПУБЛИКОВАТЬ ДЛЯ ВСЕХ</button>
    </div>

    <!-- НАВБАР -->
    <div class="nav">
        <i class="fas fa-home active" onclick="nav('home')"></i>
        <i class="fas fa-search" onclick="nav('search')"></i>
        <i class="fas fa-plus-square" style="color:var(--accent); font-size:35px" onclick="nav('publish')"></i>
        <i class="fas fa-user" onclick="nav('profile')"></i>
    </div>

    <!-- SDK FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- КОНФИГ FIREBASE (ВСТАВЬ СВОЙ ТУТ) ---
        const firebaseConfig = {
            apiKey: "ТВОЙ_КЛЮЧ",
            authDomain: "твой-проект.firebaseapp.com",
            projectId: "твой-проект",
            storageBucket: "твой-проект.appspot.com",
            messagingSenderId: "12345",
            appId: "1:12345:web:abcde"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        let userNick = localStorage.getItem('dt_nick') || 'аноним_' + Math.floor(Math.random()*9999);
        localStorage.setItem('dt_nick', userNick);

        auth.signInAnonymously().catch(e => console.error("Ошибка входа:", e));

        if(localStorage.getItem('dt_online_ok')) document.getElementById('disclaimer-overlay').style.display = 'none';

        // --- ЛОГИКА ОНЛАЙН ЛЕНТЫ ---
        function init() {
            document.getElementById('user-nick').innerText = userNick;
            // Слушаем обновления базы в реальном времени
            db.collection("posts").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                renderFeed(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
        }

        function renderFeed(posts) {
            const feed = document.getElementById('main-feed');
            feed.innerHTML = posts.map(p => `
                <div class="v-item" id="v-${p.id}">
                    <video src="${p.videoUrl}" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="sidebar">
                        <div class="btn-side" onclick="like('${p.id}')">
                            <i class="fas fa-heart"></i><br><span>${p.likes || 0}</span>
                        </div>
                    </div>
                    <div style="position:absolute; bottom:90px; left:15px">
                        <div class="v-code">${p.code}</div>
                        <h3>${p.author}</h3>
                        <p>${p.desc}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- ЗАГРУЗКА В ОБЛАКО ---
        async function uploadToCloud() {
            const file = document.getElementById('file-vid').files[0];
            const desc = document.getElementById('up-desc').value;
            if(!file) return alert("Выбери видео");

            document.getElementById('loading-overlay').style.display = 'flex';

            const fileName = Date.now() + "_" + userNick;
            const storageRef = storage.ref('videos/' + fileName);
            
            try {
                // 1. Загружаем файл
                const snapshot = await storageRef.put(file);
                const videoUrl = await snapshot.ref.getDownloadURL();
                const code = 'DT-' + Math.random().toString(36).substr(2, 4).toUpperCase();

                // 2. Сохраняем данные в Firestore
                await db.collection("posts").add({
                    videoUrl,
                    author: userNick,
                    desc: desc || "",
                    code,
                    likes: 0,
                    uid: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('loading-overlay').style.display = 'none';
                nav('home');
            } catch (e) {
                alert("Ошибка загрузки");
                console.error(e);
            }
        }

        // --- ВСПОМОГАТЕЛЬНОЕ ---
        function startVoice() {
            const text = document.getElementById('legal-text').innerText;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'ru-RU';
            utter.onend = () => document.getElementById('dis-controls').style.display = 'block';
            window.speechSynthesis.speak(utter);
        }

        function acceptAll() {
            localStorage.setItem('dt_online_ok', 'true');
            document.getElementById('disclaimer-overlay').style.display = 'none';
            init();
        }

        function nav(p) {
            document.querySelectorAll('.panel').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active'));
            if(p === 'home') document.querySelector('.fa-home').classList.add('active');
            else {
                document.getElementById('panel-'+p).style.display = 'flex';
                document.querySelector('.fa-'+(p==='profile'?'user':(p==='search'?'search':'plus-square'))).classList.add('active');
                if(p === 'profile') renderProfile();
            }
        }

        async function renderProfile() {
            const grid = document.getElementById('profile-grid');
            const snap = await db.collection("posts").where("uid", "==", auth.currentUser.uid).get();
            grid.innerHTML = snap.docs.map(doc => `
                <div class="grid-item">
                    <button class="del-btn" onclick="deletePost('${doc.id}')">✕</button>
                    <video src="${doc.data().videoUrl}"></video>
                </div>
            `).join('');
        }

        async function deletePost(id) {
            if(confirm("Удалить?")) {
                await db.collection("posts").doc(id).delete();
                renderProfile();
            }
        }

        function preview(input) {
            const url = URL.createObjectURL(input.files[0]);
            document.getElementById('up-preview').innerHTML = `<video src="${url}" muted autoplay loop style="width:100%"></video>`;
        }
    </script>
</body>
</html>
