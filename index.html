<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireTok Clean</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #ff4500;
            --bg: #000;
            --text: #fff;
            --gray: #888;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; width: 100vw; }
        
        /* --- АВТОРИЗАЦИЯ --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; padding: 30px;
        }
        input, textarea {
            width: 100%; background: #222; border: 1px solid #333; color: white;
            padding: 15px; border-radius: 10px; margin-bottom: 10px; font-size: 16px; outline: none;
        }
        .btn-primary {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 15px; border-radius: 10px; font-weight: bold; font-size: 18px; cursor: pointer;
        }

        /* --- ЛЕНТА --- */
        .app { display: none; height: 100%; flex-direction: column; }
        .feed { flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; position: relative; scrollbar-width: none; }
        .feed::-webkit-scrollbar { display: none; }
        
        .video-item {
            height: 100vh; width: 100%; scroll-snap-align: start; position: relative;
            background: #111; display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px 20px 70px 20px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9)); pointer-events: none;
        }
        .info { pointer-events: auto; max-width: 80%; }
        .u-name { font-weight: bold; font-size: 18px; margin-bottom: 5px; }
        .desc { font-size: 14px; margin-bottom: 5px; }
        .tags { color: var(--primary); font-weight: bold; }

        .sidebar {
            position: absolute; right: 10px; bottom: 100px;
            display: flex; flex-direction: column; gap: 20px; align-items: center; pointer-events: auto;
        }
        .side-btn { text-align: center; cursor: pointer; }
        .side-btn i { font-size: 30px; text-shadow: 1px 1px 3px black; transition: 0.2s; }
        .side-btn span { font-size: 12px; font-weight: bold; display: block; margin-top: 3px; }
        .liked { color: var(--primary); transform: scale(1.2); }

        /* --- КОММЕНТАРИИ --- */
        #comments-modal {
            position: fixed; bottom: -100%; left: 0; width: 100%; height: 60%;
            background: #1a1a1a; z-index: 2000; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column; transition: 0.3s;
        }
        #comments-modal.active { bottom: 0; }
        .c-header { padding: 15px; text-align: center; border-bottom: 1px solid #333; position: relative; }
        .c-list { flex: 1; overflow-y: auto; padding: 15px; }
        .c-item { margin-bottom: 15px; font-size: 14px; }
        .c-user { font-weight: bold; color: #ccc; font-size: 12px; }
        .c-input-area { padding: 10px; background: #222; display: flex; gap: 10px; }
        
        /* --- ПРОФИЛЬ И ПОИСК --- */
        .page {
            position: fixed; top: 0; left: 0; width: 100%; height: calc(100% - 60px);
            background: #000; z-index: 500; display: none; overflow-y: auto; padding: 20px;
        }
        .profile-head { text-align: center; margin-bottom: 30px; }
        .p-ava { width: 100px; height: 100px; background: #333; border-radius: 50%; margin: 0 auto 15px; border: 2px solid var(--primary); }
        .stats { display: flex; justify-content: center; gap: 30px; margin-top: 20px; }
        .stat-box b { display: block; font-size: 20px; }
        
        /* --- НАВИГАЦИЯ --- */
        .nav {
            position: fixed; bottom: 0; width: 100%; height: 60px; background: #000;
            border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 1000;
        }
        .nav i { font-size: 24px; color: #666; padding: 10px; }
        .nav i.active { color: white; }
        .add-btn { font-size: 32px; color: white !important; }

        /* --- ЗАГРУЗКА --- */
        #upload-modal { display: none; background: #000; z-index: 3000; }
        .upload-choice { display: flex; gap: 10px; margin-bottom: 15px; }
        .choice-btn { flex: 1; padding: 10px; background: #333; text-align: center; border-radius: 5px; cursor: pointer; }
        .choice-btn.active { background: var(--primary); }
    </style>
</head>
<body>

    <!-- 1. РЕГИСТРАЦИЯ -->
    <div id="auth-screen">
        <h1 style="color:var(--primary); margin-bottom: 20px; text-align:center">FireTok 3.0</h1>
        <input type="text" id="reg-name" placeholder="Твое имя">
        <input type="text" id="reg-handle" placeholder="@username">
        <button class="btn-primary" onclick="register()">Войти без правил</button>
    </div>

    <!-- 2. ПРИЛОЖЕНИЕ -->
    <div class="app" id="app">
        
        <!-- ЛЕНТА -->
        <div class="feed" id="feed"></div>

        <!-- КОММЕНТАРИИ -->
        <div id="comments-modal">
            <div class="c-header">
                Комментарии <span id="close-comm" style="position:absolute; right:15px; cursor:pointer">✕</span>
            </div>
            <div class="c-list" id="c-list"></div>
            <div class="c-input-area">
                <input type="text" id="c-input" placeholder="Напиши что угодно..." style="margin:0">
                <button class="btn-primary" style="width:50px" onclick="sendComment()">➤</button>
            </div>
        </div>

        <!-- ПРОФИЛЬ -->
        <div class="page" id="profile-page">
            <div class="profile-head">
                <div class="p-ava"></div>
                <h2 id="p-name">Name</h2>
                <p id="p-handle" style="color:gray">@user</p>
                <div class="stats">
                    <div class="stat-box"><b id="s-subs">0</b>Подписчики</div>
                    <div class="stat-box"><b id="s-likes">0</b>Лайки</div>
                    <div class="stat-box"><b id="s-vids">0</b>Видео</div>
                </div>
            </div>
            <hr style="border:1px solid #222; margin-bottom:20px">
            <h3 style="text-align:center">Твои видео</h3>
            <div id="my-videos-list" style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px">
                <!-- Сюда попадут превью твоих видео -->
            </div>
        </div>

        <!-- ПОИСК -->
        <div class="page" id="search-page">
            <input type="text" id="search-inp" placeholder="Поиск по хештегам..." oninput="doSearch()">
            <div id="search-res" style="margin-top:20px"></div>
        </div>

        <!-- ЗАГРУЗКА -->
        <div id="upload-modal" class="page" style="display:none">
            <h2>Новое видео</h2>
            <br>
            <div class="upload-choice">
                <div class="choice-btn active" onclick="setMode('file')">Файл (Временно)</div>
                <div class="choice-btn" onclick="setMode('url')">Ссылка (Навсегда)</div>
            </div>
            
            <div id="mode-file">
                <input type="file" id="file-inp" accept="video/*" style="padding:10px">
                <p style="color:gray; font-size:12px">⚠️ Файлы с телефона пропадут после обновления страницы (ограничение GitHub).</p>
            </div>
            <div id="mode-url" style="display:none">
                <input type="text" id="url-inp" placeholder="Вставь прямую ссылку на .mp4">
                <p style="color:gray; font-size:12px">✅ Ссылки работают вечно.</p>
            </div>

            <br>
            <textarea id="up-desc" placeholder="Описание..."></textarea>
            <input type="text" id="up-tags" placeholder="#хештеги">
            <button class="btn-primary" onclick="uploadVideo()">Опубликовать</button>
            <button onclick="nav('home')" style="background:transparent; color:gray; border:none; width:100%; margin-top:10px">Отмена</button>
        </div>

        <!-- МЕНЮ -->
        <div class="nav">
            <i class="fas fa-home active" onclick="nav('home')"></i>
            <i class="fas fa-search" onclick="nav('search')"></i>
            <i class="fas fa-plus-square add-btn" onclick="nav('upload')"></i>
            <i class="far fa-comment-dots" onclick="alert('Уведомлений нет')"></i>
            <i class="far fa-user" onclick="nav('profile')"></i>
        </div>
    </div>

    <script>
        // --- ДАННЫЕ ---
        let user = JSON.parse(localStorage.getItem('ft_user')) || null;
        let videos = JSON.parse(localStorage.getItem('ft_videos')) || [];
        let currentVidIdx = null;

        // --- СТАРТ ---
        if (user) startApp();
        else document.getElementById('auth-screen').style.display = 'flex';

        function register() {
            const name = document.getElementById('reg-name').value;
            const handle = document.getElementById('reg-handle').value;
            if(!name) return;
            user = { name, handle: handle.startsWith('@')?handle:'@'+handle, subs: 0, likes: 0 };
            localStorage.setItem('ft_user', JSON.stringify(user));
            startApp();
        }

        function startApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            updateProfile();
            renderFeed();
        }

        // --- ЛЕНТА И ВИДЕО ---
        function renderFeed() {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            
            if(videos.length === 0) {
                feed.innerHTML = "<div style='display:flex;height:100%;justify-content:center;align-items:center;flex-direction:column'><h3>Лента пуста</h3><p>Загрузи первое видео!</p></div>";
                return;
            }

            // Рендерим в обратном порядке (новые сверху)
            [...videos].reverse().forEach((vid, realIdx) => {
                // Вычисляем настоящий индекс в массиве videos
                const idx = videos.length - 1 - realIdx;
                
                const el = document.createElement('div');
                el.className = 'video-item';
                el.innerHTML = `
                    <video src="${vid.url}" loop onclick="togglePlay(this)" onerror="handleVideoError(this, ${idx})"></video>
                    
                    <div class="sidebar">
                        <div class="side-btn" onclick="alert('Подписка оформлена!')">
                            <div style="width:45px;height:45px;background:#333;border-radius:50%;border:2px solid white"></div>
                            <span style="background:red;color:white;border-radius:5px;margin-top:-10px;position:relative;z-index:2;font-size:10px">➕</span>
                        </div>
                        <div class="side-btn" onclick="like(${idx}, this)">
                            <i class="fas fa-heart ${vid.liked ? 'liked' : ''}"></i>
                            <span>${vid.likes}</span>
                        </div>
                        <div class="side-btn" onclick="openComments(${idx})">
                            <i class="fas fa-comment-dots"></i>
                            <span>${vid.comments.length}</span>
                        </div>
                        <div class="side-btn" onclick="repost(${idx})">
                            <i class="fas fa-share"></i>
                            <span>${vid.reposts || 0}</span>
                        </div>
                    </div>

                    <div class="overlay">
                        <div class="info">
                            <div class="u-name">${vid.author}</div>
                            <div class="desc">${vid.desc}</div>
                            <div class="tags">${vid.tags}</div>
                        </div>
                    </div>
                `;
                feed.appendChild(el);
            });

            // Наблюдатель за скроллом (Автоплей)
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const v = entry.target.querySelector('video');
                    if(entry.isIntersecting && !v.error) v.play();
                    else { v.pause(); v.currentTime = 0; }
                });
            }, {threshold: 0.6});
            
            document.querySelectorAll('.video-item').forEach(i => observer.observe(i));
        }

        // Если видео удалено (Blob истек), скрываем его
        function handleVideoError(videoEl, idx) {
            console.log("Video expired:", idx);
            // Можно удалить из массива, но чтобы не ломать индексы, просто скроем
            videoEl.parentElement.style.display = 'none';
            // Или удаляем (раскомментируй, если хочешь авто-чистку):
            // videos.splice(idx, 1);
            // localStorage.setItem('ft_videos', JSON.stringify(videos));
        }

        function togglePlay(v) { v.paused ? v.play() : v.pause(); }

        // --- ДЕЙСТВИЯ ---
        function like(idx, btn) {
            const v = videos[idx];
            v.liked = !v.liked;
            v.likes += v.liked ? 1 : -1;
            
            // Обновляем общий счетчик лайков профиля, если это мое видео
            if(v.author === user.handle && v.liked) user.likes++;
            else if (v.author === user.handle) user.likes--;

            save();
            // Визуальное обновление
            const icon = btn.querySelector('i');
            const txt = btn.querySelector('span');
            icon.classList.toggle('liked');
            txt.innerText = v.likes;
        }

        function repost(idx) {
            videos[idx].reposts = (videos[idx].reposts || 0) + 1;
            alert("Репост сделан в профиль! (имитация)");
            save();
            renderFeed(); // обновит счетчик
        }

        // --- КОММЕНТАРИИ ---
        function openComments(idx) {
            currentVidIdx = idx;
            document.getElementById('comments-modal').classList.add('active');
            renderComments();
        }

        document.getElementById('close-comm').onclick = () => {
            document.getElementById('comments-modal').classList.remove('active');
        }

        function renderComments() {
            const list = document.getElementById('c-list');
            list.innerHTML = "";
            videos[currentVidIdx].comments.forEach(c => {
                list.innerHTML += `<div class="c-item"><span class="c-user">${c.user}</span><br>${c.text}</div>`;
            });
        }

        function sendComment() {
            const txt = document.getElementById('c-input').value;
            if(!txt) return;
            videos[currentVidIdx].comments.push({user: user.handle, text: txt});
            document.getElementById('c-input').value = "";
            save();
            renderComments();
        }

        // --- ЗАГРУЗКА ---
        let uploadMode = 'file';
        function setMode(m) {
            uploadMode = m;
            document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('mode-file').style.display = m=='file'?'block':'none';
            document.getElementById('mode-url').style.display = m=='url'?'block':'none';
        }

        function uploadVideo() {
            let url = "";
            if (uploadMode === 'file') {
                const file = document.getElementById('file-inp').files[0];
                if (!file) return alert("Выбери файл!");
                url = URL.createObjectURL(file);
            } else {
                url = document.getElementById('url-inp').value;
                if (!url) return alert("Вставь ссылку!");
            }

            const newVid = {
                url: url,
                author: user.handle,
                desc: document.getElementById('up-desc').value || "Без названия",
                tags: document.getElementById('up-tags').value || "",
                likes: 0,
                comments: [],
                reposts: 0,
                liked: false
            };

            videos.push(newVid);
            save();
            
            // Сброс формы
            document.getElementById('up-desc').value = "";
            document.getElementById('up-tags').value = "";
            document.getElementById('url-inp').value = "";
            document.getElementById('file-inp').value = "";
            
            nav('home');
            alert("Опубликовано!");
        }

        // --- ПОИСК ---
        function doSearch() {
            const q = document.getElementById('search-inp').value.toLowerCase();
            const res = document.getElementById('search-res');
            res.innerHTML = "";
            
            const found = videos.filter(v => v.desc.toLowerCase().includes(q) || v.tags.toLowerCase().includes(q));
            
            found.forEach(v => {
                res.innerHTML += `
                    <div style="background:#222; padding:10px; margin-bottom:10px; border-radius:5px">
                        <b>${v.author}</b>
                        <p>${v.desc}</p>
                        <small style="color:var(--primary)">${v.tags}</small>
                    </div>
                `;
            });
        }

        // --- НАВИГАЦИЯ И ПРОФИЛЬ ---
        function nav(to) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active'));
            
            if(to === 'home') {
                renderFeed();
                document.querySelector('.fa-home').classList.add('active');
            } else if(to === 'upload') {
                document.getElementById('upload-modal').style.display = 'block';
            } else if(to === 'profile') {
                updateProfile();
                document.getElementById('profile-page').style.display = 'block';
                document.querySelector('.fa-user').classList.add('active');
            } else if(to === 'search') {
                document.getElementById('search-page').style.display = 'block';
                document.querySelector('.fa-search').classList.add('active');
            }
        }

        function updateProfile() {
            document.getElementById('p-name').innerText = user.name;
            document.getElementById('p-handle').innerText = user.handle;
            
            // Подсчет статистики
            const myVids = videos.filter(v => v.author === user.handle);
            const totalLikes = myVids.reduce((acc, v) => acc + v.likes, 0);
            
            document.getElementById('s-vids').innerText = myVids.length;
            document.getElementById('s-likes').innerText = totalLikes;
            
            // Превью видео в профиле
            const list = document.getElementById('my-videos-list');
            list.innerHTML = "";
            myVids.forEach(v => {
                list.innerHTML += `<div style="height:100px; background:#333; display:flex; align-items:center; justify-content:center; color:gray; font-size:10px; overflow:hidden"><video src="${v.url}" style="width:100%;height:100%;object-fit:cover"></video></div>`;
            });
        }

        function save() {
            localStorage.setItem('ft_videos', JSON.stringify(videos));
            localStorage.setItem('ft_user', JSON.stringify(user));
        }

    </script>
</body>
</html>
