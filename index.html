<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireTok Infinity Ultra Pro Max üî•</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --fire: #ff4500;
            --gold: #ffcc00;
            --bg: #050505;
            --panel: rgba(20, 20, 20, 0.9);
            --glass: rgba(255, 255, 255, 0.05);
            --neon: 0 0 15px var(--fire);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; overflow: hidden; height: 100vh; width: 100vw; }

        /* --- UI ANIMATIONS --- */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        .page-entry { animation: slideUp 0.4s cubic-bezier(0, 1, 0.5, 1); }

        /* --- AUTH --- */
        #auth-page { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--panel); padding: 40px; border-radius: 40px; border: 1px solid var(--fire); text-align: center; width: 90%; max-width: 400px; box-shadow: var(--neon); }
        .btn-fire { width: 100%; padding: 18px; background: linear-gradient(45deg, var(--fire), var(--gold)); border: none; border-radius: 15px; color: #000; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        input { width: 100%; padding: 15px; margin: 10px 0; background: #222; border: 1px solid #333; color: #fff; border-radius: 12px; outline: none; }

        /* --- FEED --- */
        .feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .feed::-webkit-scrollbar { display: none; }
        .v-card { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        .sidebar { position: absolute; right: 15px; bottom: 120px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 100; }
        .side-btn { text-align: center; cursor: pointer; transition: 0.2s; }
        .side-btn i { font-size: 35px; color: #fff; filter: drop-shadow(0 0 8px #000); }
        .side-btn.liked i { color: var(--fire); animation: heartPop 0.3s; }
        .side-btn span { display: block; font-size: 12px; font-weight: bold; margin-top: 4px; }

        .info { position: absolute; bottom: 100px; left: 20px; max-width: 70%; text-shadow: 2px 2px 10px #000; pointer-events: none; }
        .info h3 { color: var(--gold); pointer-events: auto; }
        .friend-btn { background: var(--fire); border: none; padding: 4px 10px; border-radius: 8px; font-size: 11px; margin-left: 10px; cursor: pointer; color: #fff; }

        /* --- COMMENTS DRAWER --- */
        .comm-drawer { position: fixed; bottom: -100%; left: 0; width: 100%; height: 70%; background: var(--panel); z-index: 6000; border-radius: 30px 30px 0 0; transition: 0.4s; display: flex; flex-direction: column; border-top: 1px solid var(--fire); }
        .comm-drawer.open { bottom: 0; }
        .comm-head { padding: 20px; text-align: center; border-bottom: 1px solid #333; font-weight: bold; position: relative; }
        .comm-list { flex: 1; overflow-y: auto; padding: 20px; }
        .comm-item { margin-bottom: 15px; font-size: 14px; }
        .comm-user { color: var(--fire); font-weight: bold; margin-right: 5px; }
        .comm-input { padding: 15px; background: #111; display: flex; gap: 10px; align-items: center; border-top: 1px solid #222; }
        .comm-input input { margin: 0; flex: 1; background: #222; border: none; padding: 12px; border-radius: 10px; color: #fff; outline: none; }

        /* --- STREAM STUDIO (PC) --- */
        #studio-pc { position: fixed; inset: 0; background: #000; z-index: 9000; display: none; grid-template-columns: 300px 1fr 350px; }
        .s-left { background: #111; border-right: 1px solid #333; padding: 20px; overflow-y: auto; }
        .s-center { background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
        .s-right { background: #111; border-left: 1px solid #333; padding: 20px; display: flex; flex-direction: column; }
        
        #preview-box { position: relative; width: 100%; height: 80vh; background: #050505; border-radius: 15px; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,1); border: 1px solid #222; }
        #live-vid { width: 100%; height: 100%; object-fit: cover; }
        #screen-vid { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; display: none; z-index: 5; }
        .overlay-item { position: absolute; z-index: 10; cursor: move; border: 1px dashed transparent; }
        .overlay-item:hover { border-color: var(--fire); }

        .studio-btn { padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 10px; cursor: pointer; margin-bottom: 10px; font-size: 13px; text-align: center; }
        .studio-btn:hover { border-color: var(--fire); color: var(--fire); }
        .active-stream { background: var(--fire) !important; color: #fff !important; }

        /* --- NAV --- */
        .nav { position: fixed; bottom: 0; width: 100%; height: 65px; background: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 5000; }
        .nav i { font-size: 22px; color: #666; cursor: pointer; transition: 0.3s; }
        .nav i.active { color: #fff; text-shadow: var(--neon); }
        .add-btn { font-size: 35px !important; color: var(--fire) !important; }

        /* --- MODALS --- */
        .modal { position: fixed; inset: 0; background: #000; z-index: 7000; display: none; flex-direction: column; overflow-y: auto; padding-bottom: 80px; }
    </style>
</head>
<body>

    <!-- AUTH -->
    <div id="auth-page">
        <div class="auth-card page-entry">
            <h1 style="color:var(--fire); font-size: 40px; margin-bottom: 20px;">FireTok üî•</h1>
            <input type="text" id="reg-name" placeholder="–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è">
            <input type="text" id="reg-user" placeholder="@username">
            <button class="btn-fire" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" style="display:none">
        <div class="feed" id="main-feed" onscroll="handleAutoplay()"></div>

        <!-- –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò -->
        <div class="comm-drawer" id="comm-drawer">
            <div class="comm-head">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ <i class="fas fa-times" onclick="toggleComm()" style="position:absolute; right:20px; cursor:pointer"></i></div>
            <div class="comm-list" id="comm-list"></div>
            <div class="comm-input">
                <input type="text" id="c-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." onkeydown="if(event.key==='Enter') sendComm()">
                <i class="fas fa-paper-plane" style="color:var(--fire)" onclick="sendComm()"></i>
            </div>
        </div>

        <!-- PROFILE -->
        <div id="profile-page" class="modal page-entry">
            <div style="padding:40px 20px; text-align:center">
                <div class="p-ava" id="p-ava"></div>
                <h2 id="p-name">User</h2>
                <div style="display:flex; justify-content:center; gap:30px; margin:20px 0">
                    <div><b id="s-friends" style="font-size:18px">0</b><br><small>–î—Ä—É–∑—å—è</small></div>
                    <div><b id="s-likes" style="font-size:18px">0</b><br><small>–õ–∞–π–∫–∏</small></div>
                    <div><b>43</b><br><small>–§—É–Ω–∫—Ü–∏–∏</small></div>
                </div>
                <button class="btn-fire" style="padding:10px; margin-bottom:10px" onclick="openStudio()">STREAM STUDIO (PC)</button>
                <button class="btn-fire" style="padding:10px; background:#111; color:#fff" onclick="location.reload()">–í–´–•–û–î</button>
            </div>
            <div id="my-grid" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:2px"></div>
        </div>

        <!-- NAVIGATION -->
        <div class="nav">
            <i class="fas fa-home active" onclick="showPage('home')"></i>
            <i class="fas fa-search" onclick="alert('–ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–µ–Ω')"></i>
            <i class="fas fa-plus-square add-btn" onclick="document.getElementById('file-up').click()"></i>
            <i class="fas fa-heart" onclick="alert('–í—Å–µ –¥—Ä—É–∑—å—è –æ–Ω–ª–∞–π–Ω')"></i>
            <i class="fas fa-user" onclick="showPage('profile')"></i>
        </div>
    </div>

    <!-- STREAM STUDIO (PC) -->
    <div id="studio-pc">
        <div class="s-left">
            <h3 style="color:var(--fire); margin-bottom:15px">40 –ù–ê–°–¢–†–û–ï–ö</h3>
            <div id="settings-area"></div>
            <script>
                const s = ["Bitrate: 8000k", "FPS: 60", "Res: 1080p", "Encoder: Hardware", "Noise Gate", "Chroma Key", "Audio Delay: 0ms", "Buffer: 2s", "GPU Accel: ON", "Low Latency"];
                document.getElementById('settings-area').innerHTML = s.map(t => `<div class="studio-btn">${t}</div>`).join('');
            </script>
        </div>
        <div class="s-center">
            <div id="preview-box">
                <video id="live-vid" autoplay playsinline muted></video>
                <video id="screen-vid" autoplay playsinline muted></video>
                <div id="overlay-zone" style="position:absolute; inset:0; pointer-events:none"></div>
            </div>
            <div style="position:absolute; bottom:20px; display:flex; gap:15px">
                <button class="btn-fire" style="width:180px" onclick="startStream()" id="stream-main-btn">–ó–ê–ü–£–°–ö</button>
                <button class="studio-btn" style="width:180px; margin:0" onclick="toggleScreen()">–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê</button>
            </div>
            <i class="fas fa-times" onclick="closeStudio()" style="position:absolute; top:20px; right:20px; font-size:30px; cursor:pointer"></i>
        </div>
        <div class="s-right">
            <h3 style="color:var(--gold); margin-bottom:15px">25 –í–ò–î–ñ–ï–¢–û–í / –û–í–ï–†–õ–ï–ò</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px">
                <button class="studio-btn" onclick="addOverlay('image')">+ –ö–ê–†–¢–ò–ù–ö–ê</button>
                <button class="studio-btn" onclick="addOverlay('video')">+ –í–ò–î–ï–û</button>
            </div>
            <div id="widgets-area" style="max-height:150px; overflow-y:auto"></div>
            <script>
                const w = ["–ß–∞—Ç", "–î–æ–Ω–∞—Ç-—Ü–µ–ª—å", "–¢–æ–ø –¥–∞—Ä–∏—Ç–µ–ª–µ–π", "–ö–æ–ª-–≤–æ –∑—Ä–∏—Ç–µ–ª–µ–π", "–û–ø–æ–≤–µ—â–µ–Ω–∏—è", "–ß–∞—Å—ã"];
                document.getElementById('widgets-area').innerHTML = w.map(t => `<div class="studio-btn" style="font-size:10px">${t}</div>`).join('');
            </script>
            <h4 style="margin-top:20px">–ß–ê–¢ –¢–†–ê–ù–°–õ–Ø–¶–ò–ò</h4>
            <div id="studio-chat" style="flex:1; background:rgba(0,0,0,0.5); margin-top:10px; padding:10px; overflow-y:auto; font-size:13px"></div>
        </div>
    </div>

    <!-- HIDDEN INPUTS -->
    <input type="file" id="file-up" accept="video/*" style="display:none" onchange="handleUpload(this)">
    <input type="file" id="overlay-file" style="display:none">

    <script>
        // --- DATA SYSTEM ---
        let db;
        const req = indexedDB.open("FireTokDB_V8", 1);
        req.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("vids", {keyPath: "id", autoIncrement: true});
        };
        req.onsuccess = e => { db = e.target.result; initApp(); };

        let user = JSON.parse(localStorage.getItem('ft_u')) || null;
        let friends = JSON.parse(localStorage.getItem('ft_f')) || [];
        let likes = JSON.parse(localStorage.getItem('ft_l')) || {};
        let currentVidId = null;

        function handleLogin() {
            const n = document.getElementById('reg-name').value;
            const u = document.getElementById('reg-user').value;
            if(!n || !u) return;
            user = { name: n, handle: u.startsWith('@')?u:'@'+u };
            localStorage.setItem('ft_u', JSON.stringify(user));
            location.reload();
        }

        function initApp() {
            if(!user) return;
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('p-name').innerText = user.name;
            document.getElementById('p-handle').innerText = user.handle;
            document.getElementById('p-ava').style.backgroundImage = `url(https://api.dicebear.com/7.x/avataaars/svg?seed=${user.handle})`;
            renderFeed();
            updateStats();
        }

        // --- FEED & LIKES ---
        async function renderFeed() {
            const feed = document.getElementById('main-feed');
            feed.innerHTML = "";
            const tx = db.transaction("vids", "readonly");
            const all = await new Promise(r => tx.objectStore("vids").getAll().onsuccess = e => r(e.target.result));

            if(all.length === 0) {
                feed.innerHTML = "<div style='text-align:center; padding-top:100px'>–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞ üî• –ó–∞–≥—Ä—É–∑–∏ –≤–∏–¥–µ–æ!</div>";
                return;
            }

            all.reverse().forEach(v => {
                const url = URL.createObjectURL(v.file);
                const isLiked = likes[v.id];
                const isFriend = friends.includes(v.author);
                
                const card = document.createElement('div');
                card.className = 'v-card';
                card.innerHTML = `
                    <video src="${url}" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="sidebar">
                        <div class="side-btn ${isLiked?'liked':''}" onclick="toggleLike(${v.id}, this)">
                            <i class="fas fa-heart"></i>
                            <span>${(v.likes||0) + (isLiked?1:0)}</span>
                        </div>
                        <div class="side-btn" onclick="openComm(${v.id})">
                            <i class="fas fa-comment-dots"></i>
                            <span>${(v.comments||[]).length}</span>
                        </div>
                        <div class="side-btn" onclick="alert('–†–µ–ø–æ—Å—Ç!')"><i class="fas fa-share"></i></div>
                    </div>
                    <div class="info">
                        <h3>${v.author} ${!isFriend && v.author!==user.handle?`<button class="friend-btn" onclick="addFriend('${v.author}', this)">+ –î—Ä—É–≥</button>`:''}</h3>
                        <p>${v.desc}</p>
                    </div>
                `;
                feed.appendChild(card);
            });
        }

        async function toggleLike(id, btn) {
            if(likes[id]) delete likes[id]; else likes[id] = true;
            localStorage.setItem('ft_l', JSON.stringify(likes));
            btn.classList.toggle('liked');
            updateStats();
        }

        function addFriend(handle, btn) {
            friends.push(handle);
            localStorage.setItem('ft_f', JSON.stringify(friends));
            btn.innerText = "‚úì –î—Ä—É–≥";
            updateStats();
        }

        // --- COMMENTS ---
        function openComm(id) {
            currentVidId = id;
            document.getElementById('comm-drawer').classList.add('open');
            renderComments();
        }
        function toggleComm() { document.getElementById('comm-drawer').classList.remove('open'); }

        async function renderComments() {
            const list = document.getElementById('comm-list');
            list.innerHTML = "";
            const tx = db.transaction("vids", "readonly");
            const v = await new Promise(r => tx.objectStore("vids").get(currentVidId).onsuccess = e => r(e.target.result));
            if(v.comments) {
                v.comments.forEach(c => {
                    list.innerHTML += `<div class="comm-item"><span class="comm-user">${c.u}</span>${c.t}</div>`;
                });
            }
        }

        async function sendComm() {
            const input = document.getElementById('c-input');
            if(!input.value) return;
            const tx = db.transaction("vids", "readwrite");
            const store = tx.objectStore("vids");
            const v = await new Promise(r => store.get(currentVidId).onsuccess = e => r(e.target.result));
            if(!v.comments) v.comments = [];
            v.comments.push({u: user.handle, t: input.value});
            store.put(v);
            input.value = "";
            tx.oncomplete = renderComments;
        }

        // --- STREAM STUDIO (PC) ---
        let camStream = null;
        let screenStream = null;

        async function openStudio() {
            if(/Android|iPhone|iPad/i.test(navigator.userAgent)) return alert("–°—Ç—É–¥–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –ü–ö!");
            document.getElementById('studio-pc').style.display = 'grid';
            try {
                camStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('live-vid').srcObject = camStream;
            } catch(e) { console.log("–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); }
        }

        async function toggleScreen() {
            if(screenStream) {
                screenStream.getTracks().forEach(t => t.stop());
                screenStream = null;
                document.getElementById('screen-vid').style.display = 'none';
            } else {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({video: true});
                    const vid = document.getElementById('screen-vid');
                    vid.srcObject = screenStream;
                    vid.style.display = 'block';
                } catch(e) { console.log("–≠–∫—Ä–∞–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω"); }
            }
        }

        function startStream() {
            const btn = document.getElementById('stream-main-btn');
            btn.classList.toggle('active-stream');
            const isLive = btn.classList.contains('active-stream');
            btn.innerText = isLive ? "–û–°–¢–ê–ù–û–í–ò–¢–¨" : "–ó–ê–ü–£–°–ö";
            if(isLive) {
                setInterval(() => {
                    const chat = document.getElementById('studio-chat');
                    const users = ["Mark", "Fire_Girl", "Alex99", "Admin"];
                    const msgs = ["–ü—Ä–∏–≤–µ—Ç!", "–¢–æ–ø —Å—Ç—Ä–∏–º üî•", "–°–¥–µ–ª–∞–π —Å–∞–ª—å—Ç–æ", "–í–∞—É!"];
                    chat.innerHTML += `<div style="margin-bottom:5px"><b>${users[Math.floor(Math.random()*4)]}:</b> ${msgs[Math.floor(Math.random()*4)]}</div>`;
                    chat.scrollTop = chat.scrollHeight;
                }, 3000);
            }
        }

        function addOverlay(type) {
            const input = document.getElementById('overlay-file');
            input.accept = type === 'image' ? 'image/*' : 'video/*';
            input.onchange = e => {
                const file = e.target.files[0];
                const url = URL.createObjectURL(file);
                const el = document.createElement(type === 'image' ? 'img' : 'video');
                el.src = url;
                el.className = 'overlay-item';
                el.style.cssText = "width:150px; top:50px; left:50px; pointer-events:auto;";
                if(type === 'video') { el.autoplay = true; el.loop = true; el.muted = true; }
                
                // Drag and drop
                el.onmousedown = function(e) {
                    let ox = e.clientX - el.offsetLeft;
                    let oy = e.clientY - el.offsetTop;
                    document.onmousemove = function(e) {
                        el.style.left = (e.clientX - ox) + 'px';
                        el.style.top = (e.clientY - oy) + 'px';
                    };
                    document.onmouseup = () => document.onmousemove = null;
                };
                document.getElementById('overlay-zone').appendChild(el);
            };
            input.click();
        }

        function closeStudio() {
            if(camStream) camStream.getTracks().forEach(t => t.stop());
            if(screenStream) screenStream.getTracks().forEach(t => t.stop());
            document.getElementById('studio-pc').style.display = 'none';
        }

        // --- CORE ---
        function showPage(p) {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active'));
            if(p === 'home') {
                document.querySelector('.fa-home').classList.add('active');
            } else {
                document.getElementById(p + '-page').style.display = 'block';
                document.querySelector(`.fa-${p==='profile'?'user':'search'}`).classList.add('active');
                if(p === 'profile') renderMyGrid();
            }
        }

        async function handleUpload(input) {
            const file = input.files[0];
            const desc = prompt("–û–ø–∏—Å–∞–Ω–∏–µ:");
            const tx = db.transaction("vids", "readwrite");
            tx.objectStore("vids").add({file, author: user.handle, desc: desc||"", likes: 0, comments: []});
            tx.oncomplete = () => location.reload();
        }

        function updateStats() {
            document.getElementById('s-friends').innerText = friends.length;
            document.getElementById('s-likes').innerText = Object.keys(likes).length;
        }

        async function renderMyGrid() {
            const grid = document.getElementById('my-grid'); grid.innerHTML = "";
            const all = await new Promise(r => db.transaction("vids", "readonly").objectStore("vids").getAll().onsuccess = e => r(e.target.result));
            all.filter(v => v.author === user.handle).forEach(v => {
                const u = URL.createObjectURL(v.file);
                grid.innerHTML += `<div style="height:150px; background:#111"><video src="${u}"></video></div>`;
            });
        }

        function handleAutoplay() {
            document.querySelectorAll('video').forEach(v => {
                const r = v.getBoundingClientRect();
                if(r.top >= 0 && r.top < window.innerHeight / 2) v.play().catch(e=>{}); else v.pause();
            });
        }
    </script>
</body>
</html>
