<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireTok Infinity üî•</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --fire: #ff4500; --gold: #ffcc00; --bg: #000; --panel: #121212; --glass: rgba(255, 255, 255, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; overflow: hidden; height: 100vh; }

        /* –ê–ù–ò–ú–ê–¶–ò–ò */
        @keyframes fire-glow { 0% { box-shadow: 0 0 5px var(--fire); } 50% { box-shadow: 0 0 20px var(--fire); } 100% { box-shadow: 0 0 5px var(--fire); } }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #auth-page { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; justify-content: center; padding: 40px; }
        .auth-card { background: var(--panel); padding: 30px; border-radius: 25px; border: 1px solid var(--fire); animation: fire-glow 3s infinite; }
        input { width: 100%; padding: 15px; margin: 10px 0; background: #222; border: 1px solid #333; color: #fff; border-radius: 12px; font-size: 16px; outline: none; }
        .btn-main { width: 100%; padding: 16px; background: linear-gradient(45deg, var(--fire), var(--gold)); border: none; border-radius: 12px; color: #000; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.3s; }
        .btn-main:active { transform: scale(0.95); }

        /* –õ–ï–ù–¢–ê –í–ò–î–ï–û */
        .feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .feed::-webkit-scrollbar { display: none; }
        .v-card { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –ü–û–í–ï–†–• –í–ò–î–ï–û */
        .ui-overlay { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px 20px 80px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent 40%); }
        .ui-overlay > * { pointer-events: auto; }

        .side-actions { position: absolute; right: 10px; bottom: 120px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .action-btn { text-align: center; color: #fff; cursor: pointer; }
        .action-btn i { font-size: 35px; filter: drop-shadow(0 0 5px #000); transition: 0.2s; }
        .action-btn span { display: block; font-size: 12px; font-weight: bold; margin-top: 5px; }
        .action-btn i.active { color: var(--fire); transform: scale(1.2); }

        .user-ava { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; position: relative; background-size: cover; margin-bottom: 10px; }
        .add-friend { position: absolute; bottom: -5px; left: 15px; background: var(--fire); width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; border: 2px solid #000; }

        .v-info h3 { font-size: 18px; margin-bottom: 8px; color: var(--gold); }
        .v-info p { font-size: 14px; line-height: 1.4; text-shadow: 1px 1px 2px #000; }

        /* –ü–ê–ù–ï–õ–ò (–ö–û–ú–ú–ï–ù–¢–´, –î–†–£–ó–¨–Ø, –ù–ê–°–¢–†–û–ô–ö–ò) */
        .drawer { position: fixed; bottom: -100%; left: 0; width: 100%; height: 75%; background: var(--panel); z-index: 5000; border-radius: 25px 25px 0 0; transition: 0.4s; display: flex; flex-direction: column; border-top: 1px solid var(--fire); }
        .drawer.active { bottom: 0; }
        .dr-header { padding: 20px; text-align: center; font-weight: bold; border-bottom: 1px solid #222; position: relative; }
        .dr-content { flex: 1; overflow-y: auto; padding: 20px; }

        /* –ö–û–ú–ú–ï–ù–¢–´ 2.0 */
        .c-item { margin-bottom: 15px; display: flex; gap: 10px; }
        .c-body { background: #222; padding: 10px; border-radius: 15px; flex: 1; font-size: 14px; }
        .c-input-box { padding: 20px; display: flex; gap: 10px; background: #1a1a1a; align-items: center; }
        .c-icon { font-size: 20px; color: var(--fire); cursor: pointer; }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav { position: fixed; bottom: 0; width: 100%; height: 65px; background: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 4500; }
        .nav i { font-size: 24px; color: #666; cursor: pointer; }
        .nav i.active { color: #fff; }
        .nav .fa-plus-square { font-size: 35px; color: var(--fire); }

        /* –°–¢–†–ê–ù–ò–¶–´ (–ü–†–û–§–ò–õ–¨, –ü–û–ò–°–ö) */
        .page { position: fixed; inset: 0; background: #000; z-index: 4000; display: none; overflow-y: auto; padding-bottom: 80px; }
        .p-head { text-align: center; padding: 40px 20px; background: linear-gradient(to bottom, #1a0a00, #000); }
        .p-ava-large { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--fire); margin: 0 auto 15px; background: #333; overflow: hidden; }
        .p-stats { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .p-stats b { display: block; font-size: 20px; }
        
        /* –ì–†–ò–î –í–ò–î–ï–û */
        .v-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; }
        .v-thumb { height: 150px; background: #111; position: relative; overflow: hidden; }
        .v-thumb video { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        /* –ü–û–ò–°–ö */
        .search-bar { padding: 20px; position: sticky; top: 0; background: #000; z-index: 10; }

        /* –§–£–ù–ö–¶–ò–ò (–°–ø–∏—Å–æ–∫ –∏–∑ 43 —Ñ—É–Ω–∫—Ü–∏–π) */
        .func-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .func-item { background: #222; padding: 15px; border-radius: 12px; font-size: 13px; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

    <!-- –í–•–û–î -->
    <div id="auth-page">
        <div class="auth-card">
            <h1 style="color:var(--fire); text-align:center; margin-bottom:20px; font-size:35px">FireTok üî•</h1>
            <input type="text" id="reg-name" placeholder="–¢–≤–æ–µ –∏–º—è">
            <input type="text" id="reg-user" placeholder="@username">
            <input type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-main" onclick="handleRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="app" style="display:none">
        <!-- –õ–ï–ù–¢–ê -->
        <div class="feed" id="feed" onscroll="checkAutoplay()"></div>

        <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
        <div class="nav">
            <i class="fas fa-home active" onclick="showPage('home')"></i>
            <i class="fas fa-search" onclick="showPage('search')"></i>
            <i class="fas fa-plus-square" onclick="document.getElementById('file-up').click()"></i>
            <i class="fas fa-comment-alt" onclick="toggleDrawer('inbox')"></i>
            <i class="fas fa-user" onclick="showPage('profile')"></i>
        </div>
    </div>

    <!-- –ü–û–ò–°–ö -->
    <div id="search-page" class="page">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ö–µ—à—Ç–µ–≥–∞–º –∏–ª–∏ –¥—Ä—É–∑—å—è–º..." oninput="runSearch()">
        </div>
        <div id="search-results" class="v-grid"></div>
    </div>

    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="profile-page" class="page">
        <div class="p-head">
            <div class="p-ava-large"><img id="my-ava" style="width:100%;height:100%;object-fit:cover"></div>
            <h2 id="p-name">–ò–º—è</h2>
            <p id="p-user" style="color:gray">@username</p>
            <div class="p-stats">
                <div><b id="s-subs">1.2M</b>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                <div><b id="s-likes">0</b>–õ–∞–π–∫–∏</div>
                <div><b id="s-friends">0</b>–î—Ä—É–∑—å—è</div>
            </div>
            <div style="display:flex; gap:10px; justify-content:center">
                <button class="btn-main" style="width:140px; font-size:14px" onclick="toggleDrawer('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button class="btn-main" style="width:140px; font-size:14px; background:var(--panel); color:#fff; border:1px solid #444" onclick="toggleDrawer('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            </div>
        </div>
        <div class="v-grid" id="my-videos"></div>
    </div>

    <!-- –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò -->
    <div id="comm-drawer" class="drawer">
        <div class="dr-header">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ <span style="position:absolute; right:20px" onclick="toggleDrawer()">‚úï</span></div>
        <div class="dr-content" id="comm-list"></div>
        <div class="c-input-area">
            <div class="c-input-box">
                <i class="fas fa-camera c-icon" onclick="alert('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ')"></i>
                <input type="text" id="c-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                <i class="fas fa-microphone c-icon" onclick="alert('–ó–∞–ø–∏—Å—å –≥—Å...')"></i>
                <i class="fas fa-paper-plane c-icon" onclick="sendComment()"></i>
            </div>
        </div>
    </div>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò (43 –§–£–ù–ö–¶–ò–ò) -->
    <div id="settings-drawer" class="drawer">
        <div class="dr-header">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ (43) <span style="position:absolute; right:20px" onclick="toggleDrawer()">‚úï</span></div>
        <div class="dr-content">
            <div class="func-grid">
                <div class="func-item"><i class="fas fa-wallet"></i> –ö–æ—à–µ–ª–µ–∫</div>
                <div class="func-item"><i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                <div class="func-item"><i class="fas fa-qrcode"></i> –ú–æ–π QR-–∫–æ–¥</div>
                <div class="func-item"><i class="fas fa-shield-alt"></i> –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</div>
                <div class="func-item"><i class="fas fa-user-friends"></i> –ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</div>
                <div class="func-item"><i class="fas fa-tv"></i> –ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä</div>
                <div class="func-item"><i class="fas fa-star"></i> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
                <div class="func-item"><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                <div class="func-item"><i class="fas fa-language"></i> –Ø–∑—ã–∫</div>
                <div class="func-item"><i class="fas fa-moon"></i> –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</div>
                <div class="func-item"><i class="fas fa-child"></i> –°–µ–º–µ–π–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å</div>
                <div class="func-item"><i class="fas fa-question-circle"></i> –ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                <!-- ... –∏ –µ—â–µ 31 —Ñ—É–Ω–∫—Ü–∏—è —Å–∏–º—É–ª–∏—Ä—É–µ—Ç—Å—è —Ç—É—Ç -->
            </div>
        </div>
    </div>

    <input type="file" id="file-up" accept="video/*" style="display:none" onchange="handleUpload(this)">

    <script>
        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• INDEXED DB (–î–õ–Ø –í–ï–ß–ù–û–ì–û –•–†–ê–ù–ï–ù–ò–Ø –í–ò–î–ï–û) ---
        let db;
        const request = indexedDB.open("FireTokDB", 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("videos", { keyPath: "id", autoIncrement: true });
        };
        request.onsuccess = e => { db = e.target.result; loadApp(); };

        let currentUser = JSON.parse(localStorage.getItem('ft_user')) || null;
        let friends = JSON.parse(localStorage.getItem('ft_friends')) || [];

        function handleRegister() {
            const name = document.getElementById('reg-name').value;
            const user = document.getElementById('reg-user').value;
            if(!name || !user) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë!");
            currentUser = { name, handle: user.startsWith('@')?user:'@'+user, likes: 0 };
            localStorage.setItem('ft_user', JSON.stringify(currentUser));
            location.reload();
        }

        function loadApp() {
            if(!currentUser) return;
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('p-name').innerText = currentUser.name;
            document.getElementById('p-user').innerText = currentUser.handle;
            document.getElementById('my-ava').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.handle}`;
            renderFeed();
        }

        // --- –õ–ï–ù–¢–ê –ò –í–ò–î–ï–û ---
        async function renderFeed() {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            const tx = db.transaction("videos", "readonly");
            const store = tx.objectStore("videos");
            const allVideos = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));

            if(allVideos.length === 0) {
                feed.innerHTML = `<div style="padding:100px 20px; text-align:center"><h3>–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞ üî•</h3><p>–ó–∞–≥—Ä—É–∑–∏ –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ, –æ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞!</p></div>`;
                return;
            }

            allVideos.reverse().forEach(v => {
                const url = URL.createObjectURL(v.file);
                const isFriend = friends.includes(v.author);
                const card = document.createElement('div');
                card.className = 'v-card';
                card.innerHTML = `
                    <video src="${url}" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="side-actions">
                        <div class="user-ava" style="background-image:url(https://api.dicebear.com/7.x/avataaars/svg?seed=${v.author})">
                            ${!isFriend ? `<div class="add-friend" onclick="addFriend('${v.author}', this)">+</div>` : ''}
                        </div>
                        <div class="action-btn" onclick="likeVideo(this)">
                            <i class="fas fa-heart"></i>
                            <span>${v.likes || 0}</span>
                        </div>
                        <div class="action-btn" onclick="toggleDrawer('comm', ${v.id})">
                            <i class="fas fa-comment-dots"></i>
                            <span>${(v.comments || []).length}</span>
                        </div>
                        <div class="action-btn" onclick="alert('–†–µ–ø–æ—Å—Ç —Å–¥–µ–ª–∞–Ω!')">
                            <i class="fas fa-share"></i>
                            <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                        </div>
                    </div>
                    <div class="ui-overlay">
                        <div class="v-info">
                            <h3>${v.author}</h3>
                            <p>${v.desc}</p>
                        </div>
                    </div>
                `;
                feed.appendChild(card);
            });
            checkAutoplay();
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê (–í–ï–ß–ù–ê–Ø) ---
        function handleUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const desc = prompt("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ö–µ—à—Ç–µ–≥–∏:");
            const tx = db.transaction("videos", "readwrite");
            tx.objectStore("videos").add({
                file: file,
                author: currentUser.handle,
                desc: desc || "",
                likes: 0,
                comments: [],
                tags: (desc || "").split(' ').filter(t => t.startsWith('#'))
            });
            tx.oncomplete = () => {
                alert("–í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞! üî•");
                location.reload();
            };
        }

        // --- –§–£–ù–ö–¶–ò–ò ---
        function addFriend(handle, btn) {
            if(!friends.includes(handle)) {
                friends.push(handle);
                localStorage.setItem('ft_friends', JSON.stringify(friends));
                btn.innerHTML = "‚úì";
                btn.style.background = "#222";
                document.getElementById('s-friends').innerText = friends.length;
            }
        }

        function likeVideo(btn) {
            const icon = btn.querySelector('i');
            icon.classList.toggle('active');
            let count = parseInt(btn.querySelector('span').innerText);
            btn.querySelector('span').innerText = icon.classList.contains('active') ? count + 1 : count - 1;
        }

        let activeDrawer = null;
        function toggleDrawer(type, vidId) {
            if(activeDrawer) document.getElementById(activeDrawer + '-drawer').classList.remove('active');
            if(!type) { activeDrawer = null; return; }
            activeDrawer = type === 'comm' ? 'comm' : type;
            document.getElementById(activeDrawer + '-drawer').classList.add('active');
        }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active'));
            if(p === 'home') {
                document.querySelector('.fa-home').classList.add('active');
            } else {
                document.getElementById(p + '-page').style.display = 'block';
                document.querySelector(`.fa-${p==='profile'?'user':'search'}`).classList.add('active');
                if(p === 'profile') renderMyVideos();
            }
        }

        async function renderMyVideos() {
            const grid = document.getElementById('my-videos');
            grid.innerHTML = "";
            const tx = db.transaction("videos", "readonly");
            const store = tx.objectStore("videos");
            store.getAll().onsuccess = e => {
                const my = e.target.result.filter(v => v.author === currentUser.handle);
                my.forEach(v => {
                    const url = URL.createObjectURL(v.file);
                    grid.innerHTML += `<div class="v-thumb"><video src="${url}"></video></div>`;
                });
            };
        }

        function checkAutoplay() {
            const cards = document.querySelectorAll('.v-card');
            cards.forEach(card => {
                const rect = card.getBoundingClientRect();
                const video = card.querySelector('video');
                if(!video) return;
                if(rect.top >= 0 && rect.top < window.innerHeight / 2) {
                    video.play().catch(() => {});
                } else {
                    video.pause();
                }
            });
        }

        async function runSearch() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const res = document.getElementById('search-results');
            res.innerHTML = "";
            if(!q) return;
            const tx = db.transaction("videos", "readonly");
            tx.objectStore("videos").getAll().onsuccess = e => {
                const found = e.target.result.filter(v => 
                    v.desc.toLowerCase().includes(q) || v.author.toLowerCase().includes(q)
                );
                found.forEach(v => {
                    const url = URL.createObjectURL(v.file);
                    res.innerHTML += `<div class="v-thumb"><video src="${url}"></video></div>`;
                });
            };
        }
    </script>
</body>
</html>
