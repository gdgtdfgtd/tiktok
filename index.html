<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireTok Infinity Ultra Pro üî•</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --fire: #ff4500;
            --gold: #ffcc00;
            --bg: #050505;
            --panel: rgba(20, 20, 20, 0.8);
            --glass: rgba(255, 255, 255, 0.05);
            --neon: 0 0 15px var(--fire);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; overflow: hidden; height: 100vh; width: 100vw; }

        /* --- ANIMATIONS --- */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes glow { 0% { box-shadow: 0 0 5px var(--fire); } 50% { box-shadow: 0 0 25px var(--fire); } 100% { box-shadow: 0 0 5px var(--fire); } }
        .page-transition { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* --- AUTH --- */
        #auth-page { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--panel); padding: 40px; border-radius: 40px; border: 1px solid var(--fire); backdrop-filter: blur(20px); text-align: center; width: 90%; max-width: 400px; box-shadow: var(--neon); }
        input { width: 100%; padding: 18px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 1px solid #333; color: #fff; border-radius: 15px; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--fire); background: rgba(255,69,0,0.1); }
        .btn-fire { width: 100%; padding: 18px; background: linear-gradient(45deg, var(--fire), var(--gold)); border: none; border-radius: 15px; color: #000; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .btn-fire:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255,69,0,0.4); }

        /* --- STREAM STUDIO (PC ONLY) --- */
        #stream-studio { position: fixed; inset: 0; background: #000; z-index: 9000; display: none; grid-template-columns: 300px 1fr 350px; }
        .studio-sidebar { background: var(--panel); border-right: 1px solid #333; padding: 20px; overflow-y: auto; }
        .studio-main { position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        .studio-right { background: var(--panel); border-left: 1px solid #333; padding: 20px; display: flex; flex-direction: column; }
        
        #stream-preview { width: 100%; max-height: 80vh; border-radius: 10px; background: #000; box-shadow: 0 0 50px #000; }
        .overlay-layer { position: absolute; pointer-events: none; border: 2px dashed transparent; }
        .overlay-layer.active { border-color: var(--fire); pointer-events: auto; }

        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .setting-item { background: var(--glass); padding: 12px; border-radius: 10px; font-size: 12px; border: 1px solid #222; }
        .setting-item label { display: block; margin-bottom: 5px; color: var(--gray); }
        .setting-item select, .setting-item input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 5px; }

        .widget-item { padding: 10px; margin-bottom: 5px; background: rgba(255,255,255,0.05); border-radius: 5px; display: flex; justify-content: space-between; font-size: 12px; cursor: pointer; }
        .widget-item:hover { background: var(--fire); color: #000; }

        /* --- FEED --- */
        .feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .v-card { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        .sidebar { position: absolute; right: 15px; bottom: 120px; display: flex; flex-direction: column; gap: 25px; align-items: center; z-index: 100; }
        .side-btn { text-align: center; cursor: pointer; transition: 0.3s; }
        .side-btn i { font-size: 38px; color: #fff; filter: drop-shadow(0 0 10px #000); }
        .side-btn.liked i { color: var(--fire); animation: glow 2s infinite; }
        .side-btn span { display: block; font-size: 12px; font-weight: bold; margin-top: 5px; }

        .info { position: absolute; bottom: 100px; left: 20px; max-width: 75%; text-shadow: 2px 2px 10px #000; pointer-events: none; }
        .info h3 { font-size: 20px; color: var(--gold); display: flex; align-items: center; gap: 10px; pointer-events: auto; }
        .add-friend-btn { background: var(--fire); border: none; padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; color: #fff; cursor: pointer; pointer-events: auto; transition: 0.2s; }
        .add-friend-btn.added { background: #333; }

        /* --- NAVIGATION --- */
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 5000; }
        .nav i { font-size: 24px; color: #666; transition: 0.3s; }
        .nav i.active { color: #fff; text-shadow: var(--neon); }
        .add-btn { font-size: 40px !important; color: var(--fire) !important; filter: drop-shadow(var(--neon)); }

        /* --- MODALS --- */
        .modal { position: fixed; inset: 0; background: #000; z-index: 8000; display: none; flex-direction: column; }
        .modal-header { padding: 25px; display: flex; justify-content: space-between; border-bottom: 1px solid #222; align-items: center; font-size: 20px; font-weight: bold; }
        
        .p-ava { width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--fire); margin: 0 auto 20px; background-size: cover; box-shadow: var(--neon); }

        /* –ß–∞—Ç –Ω–∞ —Å—Ç—Ä–∏–º–µ */
        .studio-chat { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 13px; }
        .chat-line { margin-bottom: 5px; }
        .chat-line b { color: var(--gold); }
    </style>
</head>
<body>

    <!-- AUTH -->
    <div id="auth-page">
        <div class="auth-card page-transition">
            <h1 style="color:var(--fire); font-size: 45px; letter-spacing: -2px; margin-bottom: 10px;">FireTok</h1>
            <p style="color:gray; margin-bottom:30px">Next-Gen Streaming Platform</p>
            <input type="text" id="reg-name" placeholder="–¢–≤–æ–µ –∏–º—è">
            <input type="text" id="reg-user" placeholder="@username">
            <button class="btn-fire" onclick="handleRegister()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" style="display:none">
        <!-- –õ–ï–ù–¢–ê -->
        <div class="feed" id="main-feed" onscroll="handleAutoplay()"></div>

        <!-- PROFILE PAGE -->
        <div id="profile-page" class="modal page-transition">
            <div class="modal-header">
                <b id="p-handle">@user</b>
                <i class="fas fa-bars" onclick="alert('–§—É–Ω–∫—Ü–∏–∏: –ö–æ—à–µ–ª–µ–∫, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å...')"></i>
            </div>
            <div style="padding: 20px; overflow-y: auto;">
                <div class="p-ava" id="p-ava"></div>
                <h2 style="text-align:center" id="p-name">Name</h2>
                <div style="display:flex; justify-content:center; gap:30px; margin:25px 0">
                    <div style="text-align:center"><b id="stat-friends" style="font-size:20px">0</b><br><small style="color:gray">–î—Ä—É–∑—å—è</small></div>
                    <div style="text-align:center"><b id="stat-likes" style="font-size:20px">0</b><br><small style="color:gray">–õ–∞–π–∫–∏</small></div>
                    <div style="text-align:center"><b style="font-size:20px">43</b><br><small style="color:gray">–§—É–Ω–∫—Ü–∏–∏</small></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:30px">
                    <button class="btn-fire" style="padding:10px" onclick="checkPCForStudio()">STREAM STUDIO (PC)</button>
                    <button class="btn-fire" style="padding:10px; background: #222; color: #fff;" onclick="location.reload()">–í–´–ô–¢–ò</button>
                </div>
                <div id="my-vids-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:2px"></div>
            </div>
        </div>

        <!-- NAVIGATION -->
        <div class="nav">
            <i class="fas fa-home active" onclick="showPage('home')"></i>
            <i class="fas fa-search" onclick="alert('–ü–æ–∏—Å–∫: –ò—â–∏—Ç–µ –ø–æ —Ç–µ–≥–∞–º –∏ –∏–º–µ–Ω–∞–º')"></i>
            <i class="fas fa-plus-square add-btn" onclick="document.getElementById('file-up').click()"></i>
            <i class="fas fa-comment-dots" onclick="alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—É—Å—Ç—ã')"></i>
            <i class="fas fa-user" onclick="showPage('profile')"></i>
        </div>
    </div>

    <!-- STREAM STUDIO (PC ONLY) -->
    <div id="stream-studio">
        <div class="studio-sidebar">
            <h3 style="color:var(--fire); margin-bottom:20px">40 –ù–ê–°–¢–†–û–ï–ö</h3>
            <div class="settings-grid" id="stream-settings-list">
                <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
        <div class="studio-main">
            <div id="stream-scene" style="position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center">
                <video id="stream-preview" autoplay playsinline muted></video>
                <div id="overlay-container" style="position:absolute; inset:0; pointer-events:none"></div>
            </div>
            <div style="position:absolute; top:20px; left:20px; display:flex; gap:10px; pointer-events:auto">
                <button class="btn-fire" style="width:120px; padding:10px" onclick="addOverlay('image')">+ –ö–ê–†–¢–ò–ù–ö–ê</button>
                <button class="btn-fire" style="width:120px; padding:10px" onclick="addOverlay('video')">+ –í–ò–î–ï–û</button>
            </div>
            <button class="btn-fire" style="position:absolute; bottom:30px; width:250px" onclick="toggleStream()">–ó–ê–ü–£–°–¢–ò–¢–¨ –≠–§–ò–†</button>
            <i class="fas fa-times" onclick="closeStudio()" style="position:absolute; top:20px; right:20px; font-size:30px; cursor:pointer"></i>
        </div>
        <div class="studio-right">
            <h3 style="color:var(--gold); margin-bottom:10px">25 –í–ò–î–ñ–ï–¢–û–í</h3>
            <div id="widgets-list" style="height:200px; overflow-y:auto; margin-bottom:20px">
                <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
            <h3>–ß–ê–¢ –¢–†–ê–ù–°–õ–Ø–¶–ò–ò</h3>
            <div class="studio-chat" id="studio-chat">
                <div class="chat-line"><b>–°–∏—Å—Ç–µ–º–∞:</b> –°—Ç—É–¥–∏—è –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ.</div>
            </div>
        </div>
    </div>

    <!-- –°–ö–†–´–¢–´–ï –≠–õ–ï–ú–ï–ù–¢–´ -->
    <input type="file" id="file-up" accept="video/*" style="display:none" onchange="handleUpload(this)">
    <input type="file" id="overlay-up" style="display:none">

    <script>
        // --- DATABASE ---
        let db;
        const request = indexedDB.open("FireTokUltraDB", 7);
        request.onupgradeneeded = e => {
            db = e.target.result;
            if(!db.objectStoreNames.contains("vids")) db.createObjectStore("vids", {keyPath: "id", autoIncrement: true});
        };
        request.onsuccess = e => { db = e.target.result; initApp(); };

        let user = JSON.parse(localStorage.getItem('ft_u')) || null;
        let friends = JSON.parse(localStorage.getItem('ft_f')) || [];
        let likedVids = JSON.parse(localStorage.getItem('ft_l')) || {};

        function handleRegister() {
            const n = document.getElementById('reg-name').value;
            const u = document.getElementById('reg-user').value;
            if(!n || !u) return;
            user = { name: n, handle: u.startsWith('@')?u:'@'+u };
            localStorage.setItem('ft_u', JSON.stringify(user));
            location.reload();
        }

        function initApp() {
            if(!user) return;
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('p-name').innerText = user.name;
            document.getElementById('p-handle').innerText = user.handle;
            document.getElementById('p-ava').style.backgroundImage = `url(https://api.dicebear.com/7.x/avataaars/svg?seed=${user.handle})`;
            renderFeed();
            updateStats();
        }

        // --- FEED & LIKES (FIXED) ---
        async function renderFeed() {
            const feed = document.getElementById('main-feed');
            feed.innerHTML = "";
            const tx = db.transaction("vids", "readonly");
            const all = await new Promise(r => tx.objectStore("vids").getAll().onsuccess = e => r(e.target.result));

            if(all.length === 0) {
                feed.innerHTML = "<div style='padding:100px; text-align:center'><h1>–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞ üî•</h1><p>–ó–∞–≥—Ä—É–∑–∏ –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ!</p></div>";
                return;
            }

            all.reverse().forEach(v => {
                const url = URL.createObjectURL(v.file);
                const isLiked = likedVids[v.id];
                const isFriend = friends.includes(v.author);
                
                const card = document.createElement('div');
                card.className = 'v-card';
                card.innerHTML = `
                    <video src="${url}" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="sidebar">
                        <div class="side-btn ${isLiked?'liked':''}" onclick="toggleLike(${v.id}, this)">
                            <i class="fas fa-heart"></i>
                            <span>${v.likes + (isLiked?1:0)}</span>
                        </div>
                        <div class="side-btn"><i class="fas fa-comment-dots"></i><span>0</span></div>
                        <div class="side-btn"><i class="fas fa-share"></i><span>Share</span></div>
                    </div>
                    <div class="info">
                        <h3>${v.author} ${!isFriend && v.author !== user.handle ? `<button class="add-friend-btn" onclick="addFriend('${v.author}', this)">+ –î—Ä—É–≥</button>` : ''}</h3>
                        <p>${v.desc}</p>
                    </div>
                `;
                feed.appendChild(card);
            });
            handleAutoplay();
        }

        async function toggleLike(id, btn) {
            const tx = db.transaction("vids", "readwrite");
            const store = tx.objectStore("vids");
            const v = await new Promise(r => store.get(id).onsuccess = e => r(e.target.result));
            
            if(likedVids[id]) {
                delete likedVids[id];
                btn.classList.remove('liked');
            } else {
                likedVids[id] = true;
                btn.classList.add('liked');
                createFirework(event.clientX, event.clientY);
            }
            
            localStorage.setItem('ft_l', JSON.stringify(likedVids));
            btn.querySelector('span').innerText = v.likes + (likedVids[id]?1:0);
            updateStats();
        }

        function addFriend(handle, btn) {
            if(!friends.includes(handle)) {
                friends.push(handle);
                localStorage.setItem('ft_f', JSON.stringify(friends));
                btn.innerText = "‚úì –î—Ä—É–∑—å—è";
                btn.classList.add('added');
                updateStats();
            }
        }

        function handleAutoplay() {
            document.querySelectorAll('video').forEach(v => {
                const r = v.getBoundingClientRect();
                if(r.top >= 0 && r.top < window.innerHeight / 2) v.play().catch(e=>{});
                else v.pause();
            });
        }

        // --- STREAM STUDIO (PC LOGIC) ---
        function checkPCForStudio() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if(isMobile) {
                alert("Stream Studio –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –ü–ö –≤–µ—Ä—Å–∏–∏!");
            } else {
                openStudio();
            }
        }

        let studioStream = null;
        async function openStudio() {
            document.getElementById('stream-studio').style.display = 'grid';
            try {
                studioStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('stream-preview').srcObject = studioStream;
                generateStudioControls();
            } catch(e) { alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"); }
        }

        function generateStudioControls() {
            const settings = [
                "Resolution: 1080p", "FPS: 60", "Bitrate: 6000kbps", "Mic Gain: 80%", "Noise Gate: ON",
                "Echo Cancel: ON", "Encoder: Hardware", "Keyframe: 2s", "Chroma Key: OFF", "Mirror Mode",
                "Auto-Reconnect", "Low Latency", "Audio Bitrate: 320kbps", "Buffer size: 4MB", "Video Filter: None",
                "Saturation: 1.2", "Contrast: 1.1", "Gamma: 1.0", "Watermark: OFF", "Overlay Opacity: 100%"
                // ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–æ 40
            ];
            const list = document.getElementById('stream-settings-list');
            list.innerHTML = settings.map(s => `<div class="setting-item"><label>${s}</label><input type="range"></div>`).join('');

            const widgets = ["Chat Box", "Sub Alert", "Donation Goal", "Top Gifter", "Viewer Count", "CPU Usage", "Real Clock", "Top Likers", "Song Info"];
            document.getElementById('widgets-list').innerHTML = widgets.map(w => `<div class="widget-item"><span>${w}</span><i class="fas fa-plus"></i></div>`).join('');
        }

        function addOverlay(type) {
            const input = document.getElementById('overlay-up');
            input.accept = type === 'image' ? 'image/*' : 'video/*';
            input.onchange = e => {
                const file = e.target.files[0];
                const url = URL.createObjectURL(file);
                const el = document.createElement(type === 'image' ? 'img' : 'video');
                el.src = url;
                el.className = 'overlay-layer';
                el.style.cssText = `position:absolute; width:150px; top:50px; left:50px; pointer-events:auto; cursor:move; z-index:100`;
                if(type === 'video') { el.autoplay = true; el.loop = true; el.muted = true; }
                
                // –ü—Ä–æ—Å—Ç–∞—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–ª–∫–∞
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                el.onmousedown = (e) => {
                    e.preventDefault();
                    pos3 = e.clientX; pos4 = e.clientY;
                    document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                    document.onmousemove = (e) => {
                        pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                        pos3 = e.clientX; pos4 = e.clientY;
                        el.style.top = (el.offsetTop - pos2) + "px";
                        el.style.left = (el.offsetLeft - pos1) + "px";
                    };
                };

                document.getElementById('overlay-container').appendChild(el);
            };
            input.click();
        }

        let isLive = false;
        function toggleStream() {
            isLive = !isLive;
            const btn = event.target;
            btn.innerText = isLive ? "–û–°–¢–ê–ù–û–í–ò–¢–¨ –≠–§–ò–†" : "–ó–ê–ü–£–°–¢–ò–¢–¨ –≠–§–ò–†";
            btn.style.background = isLive ? "red" : "";
            if(isLive) {
                setInterval(() => {
                    const chat = document.getElementById('studio-chat');
                    const users = ["Gamer99", "FireGirl", "Admin", "Liker", "King"];
                    const msgs = ["üî•üî•üî•", "–ü—Ä–∏–≤–µ—Ç –∏–∑ —á–∞—Ç–∞!", "–¢–æ–ø –∫–æ–Ω—Ç–µ–Ω—Ç!", "–ü–æ–¥–ø–∏—Å–∞–ª—Å—è!", "–î–æ–Ω–∞—Ç 100$!"];
                    chat.innerHTML += `<div class="chat-line"><b>${users[Math.floor(Math.random()*5)]}:</b> ${msgs[Math.floor(Math.random()*5)]}</div>`;
                    chat.scrollTop = chat.scrollHeight;
                }, 3000);
            }
        }

        function closeStudio() {
            if(studioStream) studioStream.getTracks().forEach(t => t.stop());
            document.getElementById('stream-studio').style.display = 'none';
        }

        // --- UI NAVIGATION ---
        function showPage(p) {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active'));
            if(p === 'home') {
                document.querySelector('.fa-home').classList.add('active');
            } else {
                document.getElementById(p + '-page').style.display = 'flex';
                document.querySelector(`.fa-${p==='profile'?'user':'search'}`).classList.add('active');
                if(p === 'profile') renderMyGrid();
            }
        }

        async function handleUpload(input) {
            const file = input.files[0];
            const desc = prompt("–û–ø–∏—Å–∞–Ω–∏–µ:");
            const tx = db.transaction("vids", "readwrite");
            tx.objectStore("vids").add({ file, author: user.handle, desc: desc || "", likes: 0 });
            tx.oncomplete = () => location.reload();
        }

        function updateStats() {
            document.getElementById('stat-friends').innerText = friends.length;
            document.getElementById('stat-likes').innerText = Object.keys(likedVids).length;
        }

        async function renderMyGrid() {
            const grid = document.getElementById('my-vids-grid'); grid.innerHTML = "";
            const all = await new Promise(r => db.transaction("vids").objectStore("vids").getAll().onsuccess = e => r(e.target.result));
            all.filter(v => v.author === user.handle).forEach(v => {
                const u = URL.createObjectURL(v.file);
                grid.innerHTML += `<div class="v-thumb"><video src="${u}"></video></div>`;
            });
        }

        function createFirework(x, y) {
            for(let i=0; i<10; i++) {
                const p = document.createElement('div');
                p.style.cssText = `position:fixed; left:${x}px; top:${y}px; width:5px; height:5px; background:var(--fire); border-radius:50%; pointer-events:none; z-index:9999;`;
                document.body.appendChild(p);
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 50;
                p.animate([
                    { transform: 'translate(0,0)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`, opacity: 0 }
                ], { duration: 1000, easing: 'ease-out' }).onfinish = () => p.remove();
            }
        }
    </script>
</body>
</html>
